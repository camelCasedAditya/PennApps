<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Editor - {{ lesson.lesson_name }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #f8fafb;
        }
        
        .layout { 
            display: flex; 
            /* Use exact viewport height so sidebars and editor size correctly */
            height: 100vh; 
        }
        
        .content { 
            flex: 1; 
            position: relative; 
        }
        
        .right-sidebar {
            width: 350px;
            background: white;
            border-left: 1px solid #e5e7eb;
            padding: 0;
            box-sizing: border-box;
            /* Make the sidebar fill the viewport and manage its own scrolling */
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: -4px 0 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        #control-panel {
            background: white;
            padding: 24px;
            border-radius: 0;
            box-shadow: none;
            margin-bottom: 0;
            /* Let the content scroll within the sidebar, keeping header/footer visible */
            flex: 1;
            min-height: 0; /* allow child scrollers to size correctly */
            overflow-y: auto;
        }
        
        #correct-btn, #save-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 8px 0;
            width: 100%;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        #correct-btn:hover, #save-btn:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e3a8a 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 8px -1px rgba(0, 0, 0, 0.15);
        }
        
        #correct-btn:disabled, #save-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        #status-message {
            margin-top: 16px;
            font-size: 14px;
            min-height: 24px;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 500;
        }
        
        .success { 
            color: #059669; 
            background: #ecfdf5;
            border: 1px solid #a7f3d0;
        }
        
        .error { 
            color: #dc2626; 
            background: #fef2f2;
            border: 1px solid #fca5a5;
        }
        
        .info { 
            color: #0369a1; 
            background: #f0f9ff;
            border: 1px solid #7dd3fc;
        }
        
        iframe { 
            width: 100%; 
            height: 100vh; 
            border: none; 
            display: block; /* avoid extra space below iframe */
        }
        
        #lesson-info {
            font-size: 14px;
            color: #374151;
            margin-bottom: 20px;
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 8px;
            border: 1px solid #bae6fd;
        }
        
        #lesson-info strong {
            color: #0c4a6e;
            font-size: 16px;
            font-weight: 700;
            display: block;
            margin-bottom: 8px;
        }
        
        #correction-result {
            margin-top: 20px;
            padding: 0;
            background: white;
            border-radius: 8px;
            font-size: 14px;
            overflow: hidden;
            display: none;
            max-height: 60vh;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        #correction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 16px 20px;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            color: #374151;
        }
        
        #correction-header:hover {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        }
        
        #correction-content {
            overflow-y: auto;
            padding: 20px;
            max-height: 50vh;
            line-height: 1.6;
        }
        
        #correction-content.collapsed {
            display: none;
        }
        
        #correction-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        #correction-content li {
            margin: 4px 0;
            color: #374151;
        }
        
        #correction-content strong {
            color: #111827;
            font-weight: 600;
            display: block;
            margin: 16px 0 8px 0;
        }
        
        #correction-content .success {
            color: #059669;
            font-weight: 700;
            font-size: 16px;
        }
        
        #correction-content .error {
            color: #dc2626;
            font-weight: 700;
            font-size: 16px;
        }
        
        #minimize-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            color: #6b7280;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        #minimize-btn:hover {
            color: #374151;
            background: #f3f4f6;
        }

        /* Live feedback panel (final project only) */
        #live-feedback {
            margin-top: 20px;
            padding: 0;
            background: white;
            border-radius: 8px;
            font-size: 14px;
            overflow: hidden;
            display: none; /* shown only for final project */
            max-height: 55vh;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        #live-feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            color: #374151;
        }
        #live-feedback-content {
            overflow-y: auto;
            padding: 20px;
            max-height: 50vh;
            line-height: 1.6;
        }
        #live-feedback-content ul { margin: 8px 0; padding-left: 20px; }
        #live-feedback-content li { margin: 6px 0; color: #374151; }
    </style>
</head>
<body>
    <div class="layout">
        {% include 'generation/_sidebar.html' %}
        <div class="content">
            <iframe id="code-editor" src="http://localhost:8080/?folder=/home/coder/workspace" frameborder="0"></iframe>
        </div>
        <div class="right-sidebar">
            <div id="control-panel" data-is-final-project="{{ project.is_final_project|yesno:'true,false' }}">
                <div id="lesson-info">
                    <strong>{{ lesson.lesson_name }}</strong><br>
                    {{ lesson.lesson_description|truncatechars:100 }}
                </div>

                <button id="correct-btn" onclick="submitForCorrection()">Analyze All Files</button>
                <button id="save-btn" onclick="saveProject()">Save Project</button>

                <div id="status-message"></div>
                <div id="correction-result">
                    <div id="correction-header" onclick="toggleCorrection()">
                        <strong>Code Feedback</strong>
                        <button id="minimize-btn" title="Minimize/Maximize">−</button>
                    </div>
                    <div id="correction-content">
                        <!-- Feedback content will be inserted here by JavaScript -->
                    </div>
                </div>

                <!-- Live feedback (auto-updating every 10s) for final project -->
                <div id="live-feedback">
                    <div id="live-feedback-header">
                        <strong>Live Feedback (auto-updates every 10s)</strong>
                        <span id="live-feedback-status" style="font-size: 12px; color: #6b7280;">Idle</span>
                    </div>
                    <div id="live-feedback-content">
                        <ul id="live-feedback-list"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    const IS_FINAL_PROJECT = (document.getElementById('control-panel')?.dataset?.isFinalProject === 'true');

        function toggleCorrection() {
            const content = document.getElementById('correction-content');
            const btn = document.getElementById('minimize-btn');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                btn.textContent = '−';
                btn.title = 'Minimize';
            } else {
                content.classList.add('collapsed');
                btn.textContent = '+';
                btn.title = 'Maximize';
            }
        }

        function showStatus(message, isError = false, isInfo = false) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            if (isError) {
                statusEl.className = 'error';
            } else if (isInfo) {
                statusEl.className = 'info';
            } else {
                statusEl.className = 'success';
            }
        }

        // Live feedback polling for final projects
        async function pollLiveFeedback() {
            const status = document.getElementById('live-feedback-status');
            const list = document.getElementById('live-feedback-list');
            try {
                status.textContent = 'Updating…';
                const res = await fetch(`/generation/lesson/{{ lesson.id }}/final_project_feedback/`, { method: 'GET' });
                const data = await res.json();
                list.innerHTML = '';
                if (data && data.success && Array.isArray(data.bullets)) {
                    const bullets = data.bullets.filter(b => typeof b === 'string' && b.trim().length > 0).slice(0, 5);
                    if (bullets.length === 0) {
                        list.innerHTML = '<li>No feedback yet. Keep coding and check back shortly.</li>';
                    } else {
                        for (const b of bullets) {
                            const li = document.createElement('li');
                            li.textContent = b;
                            list.appendChild(li);
                        }
                    }
                    status.textContent = 'Live';
                } else {
                    status.textContent = 'Error';
                    list.innerHTML = '<li>Feedback temporarily unavailable. Will retry…</li>';
                }
            } catch (e) {
                console.error('Live feedback error:', e);
                const list = document.getElementById('live-feedback-list');
                status.textContent = 'Error';
                list.innerHTML = '<li>Network error while fetching feedback.</li>';
            }
        }

        function startLiveFeedback() {
            const panel = document.getElementById('live-feedback');
            const correctBtn = document.getElementById('correct-btn');
            const correctionResult = document.getElementById('correction-result');
            // Hide manual correction and show live panel
            if (correctBtn) correctBtn.style.display = 'none';
            if (correctionResult) correctionResult.style.display = 'none';
            if (panel) panel.style.display = 'block';
            showStatus('Live feedback enabled. We\'ll analyze your project every 10 seconds.', false, true);
            // Initial fetch
            pollLiveFeedback();
            // Interval
            window.__liveFeedbackInterval = setInterval(pollLiveFeedback, 10000);
            // Cleanup on unload
            window.addEventListener('beforeunload', () => {
                if (window.__liveFeedbackInterval) {
                    clearInterval(window.__liveFeedbackInterval);
                }
            });
        }

        async function getWorkspaceFiles() {
            try {
                // Get files from the workspace directory via Django backend
                const response = await fetch('/courses/get_workspace_files/', {
                    method: 'GET',
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.files || [];
                } else {
                    throw new Error('Failed to get workspace files');
                }
            } catch (error) {
                console.error('Error getting workspace files:', error);
                // Fallback: return the main.py file that we know exists
                return [
                    {
                        relative_path: 'main.py',
                        content: '# Write your code here\nprint("Hello World")\n'
                    }
                ];
            }
        }

        async function submitForCorrection() {
            const correctBtn = document.getElementById('correct-btn');
            const correctionResult = document.getElementById('correction-result');

            correctBtn.disabled = true;
            correctBtn.textContent = 'Analyzing All Files...';
            showStatus('Analyzing project files (excluding venv/cache)...', false, true);

            try {
                const response = await fetch(`/generation/lesson/{{ lesson.id }}/correct/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showStatus('✓ Project analysis completed!');

                    const correction = result.correction;
                    correctionResult.style.display = 'block';
                    
                    // Display pass/fail prominently
                    const passFailClass = correction.pass_fail === 'PASS' ? 'success' : 'error';
                    const passFailHtml = `<div style="font-size: 16px; font-weight: bold; margin-bottom: 10px;" class="${passFailClass}">Result: ${correction.pass_fail}</div>`;
                    
                    // Build file analysis section if available
                    let fileAnalysisHtml = '';
                    if (correction.file_analysis) {
                        fileAnalysisHtml = '<strong>File-Specific Analysis:</strong><br>';
                        for (const [filename, analysis] of Object.entries(correction.file_analysis)) {
                            fileAnalysisHtml += `<div style="margin: 5px 0; padding: 5px; background: #f0f0f0; border-radius: 3px;">
                                <strong>${filename}:</strong> ${analysis}
                            </div>`;
                        }
                        fileAnalysisHtml += '<br>';
                    }
                    
                    // Build corrected files section if available
                    let correctedFilesHtml = '';
                    if (correction.corrected_code && typeof correction.corrected_code === 'object') {
                        const correctedFilesList = Object.keys(correction.corrected_code);
                        if (correctedFilesList.length > 0) {
                            correctedFilesHtml = `<strong>Files Updated:</strong> ${correctedFilesList.join(', ')}<br><br>`;
                        }
                    }
                    
                    const correctionContent = document.getElementById('correction-content');
                    correctionContent.innerHTML = `
                        ${passFailHtml}
                        ${correctedFilesHtml}
                        <strong>Issues Found:</strong>
                        <ul>${correction.issues_found.map(issue => `<li>${issue}</li>`).join('')}</ul>
                        ${fileAnalysisHtml}
                        <strong>Overall Explanation:</strong><br>
                        ${correction.explanation}
                        <strong>Improvement Suggestions:</strong>
                        <ul>${correction.suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}</ul>
                    `;

                    // If lesson marked completed, surface a nice message
                    if (result.lesson_completed) {
                        showStatus('✓ Lesson marked as completed!', false, false);
                    }
                } else {
                    showStatus(`Error: ${result.message}`, true);
                }

            } catch (error) {
                console.error('Correction error:', error);
                showStatus('Failed to get code correction', true);
            } finally {
                correctBtn.disabled = false;
                correctBtn.textContent = 'Analyze All Files';
            }
        }

        async function saveProject() {
            const saveBtn = document.getElementById('save-btn');

            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            showStatus('Saving project...', false, true);

            try {
                // Get current files from workspace
                const files = await getWorkspaceFiles();
                console.log('Files retrieved:', files);

                const projectData = {
                    project_name: "{{ project.name }}",
                    project_description: "{{ project.description }}",
                    files: files
                };

                console.log('Sending project data:', projectData);

                const response = await fetch('/courses/save_project/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(projectData)
                });

                const result = await response.json();

                if (result.success) {
                    showStatus(`✓ ${result.message} (${result.files_saved} files saved)`);
                } else {
                    showStatus(`Error: ${result.message}`, true);
                }

            } catch (error) {
                console.error('Save error:', error);
                showStatus('Failed to save project', true);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Project';
            }
        }

        // Optional: Submit for correction with Ctrl+Enter (disabled for final project)
        document.addEventListener('keydown', function(e) {
            if (!IS_FINAL_PROJECT && e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                submitForCorrection();
            }
        });

        // Optional: Save with Ctrl+S
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveProject();
            }
        });

        // Start live feedback if this is the final project
        if (IS_FINAL_PROJECT) {
            startLiveFeedback();
        }
    </script>
</body>
</html>